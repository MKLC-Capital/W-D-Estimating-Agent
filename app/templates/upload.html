{% extends "base.html" %}
{% block title %}AI Takeoff{% endblock %}

{% block content %}
<section class="hero-gradient text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <p class="text-accent font-semibold text-sm tracking-widest uppercase mb-2">AI-Powered Estimating</p>
        <h1 class="text-3xl md:text-4xl font-bold">Upload Schedule &rarr; Instant Quote</h1>
        <p class="text-blackline-300 mt-3 max-w-2xl">Upload your window and door schedule (PDF or image). Our AI agent reads the document, extracts every line item, matches to our product catalogue, and generates a priced quote.</p>
    </div>
</section>

<section class="py-12 bg-blackline-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Upload Area -->
        <div id="uploadArea" class="bg-white rounded-lg shadow-sm border-2 border-dashed border-blackline-300 p-12 text-center mb-8 hover:border-accent transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFileSelect(event)">
            <svg class="w-16 h-16 text-blackline-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <h3 class="text-lg font-bold text-blackline-700 mb-2">Drop your schedule here</h3>
            <p class="text-blackline-400 text-sm">or click to browse. Accepts PDF, PNG, JPG.</p>
            <div id="fileName" class="mt-4 text-accent font-semibold hidden"></div>
        </div>

        <!-- What we accept -->
        <div class="bg-white rounded-lg shadow-sm border border-blackline-100 p-6 mb-8">
            <h3 class="font-bold mb-3">What to upload</h3>
            <div class="grid md:grid-cols-3 gap-4 text-sm">
                <div class="flex items-start gap-3">
                    <span class="text-accent font-bold text-lg">&#10003;</span>
                    <div>
                        <div class="font-semibold">Window Schedule</div>
                        <div class="text-blackline-500">Table listing all windows with sizes, types, and notes</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-accent font-bold text-lg">&#10003;</span>
                    <div>
                        <div class="font-semibold">Door Schedule</div>
                        <div class="text-blackline-500">Table listing all doors with dimensions, hardware, and glazing</div>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-blackline-300 font-bold text-lg">&#9734;</span>
                    <div>
                        <div class="font-semibold">Floor Plans (optional)</div>
                        <div class="text-blackline-500">Helps provide context for window/door placement</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Process Button -->
        <button id="processBtn" onclick="processUpload()" disabled class="w-full btn-primary text-blackline-950 py-4 rounded font-semibold text-lg disabled:opacity-40 disabled:cursor-not-allowed mb-8">
            Run AI Takeoff &amp; Generate Quote
        </button>

        <!-- Processing Animation -->
        <div id="processing" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border border-blackline-100 p-8">
                <div class="flex items-center justify-center mb-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blackline-200 border-t-accent"></div>
                </div>
                <div class="text-center">
                    <h3 class="text-lg font-bold mb-2">AI Agent Processing</h3>
                    <div id="processingSteps" class="text-sm text-blackline-500 space-y-2">
                    </div>
                </div>
            </div>
        </div>

        <!-- Extraction Results -->
        <div id="extractionResults" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border border-blackline-100 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold">AI Extraction Results</h2>
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full" id="confidenceBadge"></span>
                </div>
                <div id="extractionSummary" class="grid grid-cols-3 gap-4 mb-6">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b-2 border-blackline-200">
                                <th class="text-left py-3 px-2 font-semibold text-blackline-600">Ref</th>
                                <th class="text-left py-3 px-2 font-semibold text-blackline-600">Extracted Description</th>
                                <th class="text-left py-3 px-2 font-semibold text-blackline-600">Matched Product</th>
                                <th class="text-left py-3 px-2 font-semibold text-blackline-600">Glass</th>
                                <th class="text-right py-3 px-2 font-semibold text-blackline-600">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="extractionTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex gap-4 justify-end">
                <button onclick="editExtraction()" class="border border-blackline-300 text-blackline-700 px-8 py-3 rounded font-semibold hover:border-accent hover:text-accent transition">
                    Edit in Quote Builder
                </button>
                <button onclick="generateFromExtraction()" class="btn-primary text-blackline-950 px-8 py-3 rounded font-semibold">
                    Generate Quote from Extraction
                </button>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;
let extractionData = null;

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileName').classList.remove('hidden');
        document.getElementById('processBtn').disabled = false;
        document.getElementById('uploadArea').classList.remove('border-blackline-300');
        document.getElementById('uploadArea').classList.add('border-accent');
    }
}

async function processUpload() {
    if (!selectedFile) return;

    document.getElementById('uploadArea').classList.add('hidden');
    document.getElementById('processBtn').classList.add('hidden');
    document.getElementById('processing').classList.remove('hidden');

    const steps = [
        'Reading document...',
        'Detecting table structure...',
        'Extracting window schedule items...',
        'Extracting door schedule items...',
        'Matching to product catalogue...',
        'Applying glass and finish defaults...',
        'Calculating pricing...',
        'Building quote...',
    ];

    const stepsEl = document.getElementById('processingSteps');

    for (let i = 0; i < steps.length; i++) {
        await new Promise(r => setTimeout(r, 400 + Math.random() * 300));
        const stepEl = document.createElement('div');
        stepEl.className = 'flex items-center justify-center gap-2';
        stepEl.innerHTML = `<span class="text-accent">&#10003;</span> ${steps[i]}`;
        stepsEl.appendChild(stepEl);
    }

    // Call API
    const resp = await fetch('/api/takeoff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: selectedFile.name }),
    });
    extractionData = await resp.json();

    await new Promise(r => setTimeout(r, 500));
    document.getElementById('processing').classList.add('hidden');
    showExtractionResults(extractionData);
}

function showExtractionResults(data) {
    document.getElementById('extractionResults').classList.remove('hidden');
    document.getElementById('confidenceBadge').textContent = `${Math.round(data.confidence * 100)}% confidence`;

    const summary = data.summary;
    document.getElementById('extractionSummary').innerHTML = `
        <div class="bg-blackline-50 rounded p-4 text-center">
            <div class="text-2xl font-bold">${summary.total_windows}</div>
            <div class="text-xs text-blackline-500">Windows</div>
        </div>
        <div class="bg-blackline-50 rounded p-4 text-center">
            <div class="text-2xl font-bold">${summary.total_doors}</div>
            <div class="text-xs text-blackline-500">Doors</div>
        </div>
        <div class="bg-blackline-50 rounded p-4 text-center">
            <div class="text-2xl font-bold">${summary.unique_types}</div>
            <div class="text-xs text-blackline-500">Unique Types</div>
        </div>
    `;

    const tbody = document.getElementById('extractionTable');
    const glassLookup = {{ glass_json | safe }};

    data.extracted_items.forEach((item, i) => {
        const glass = glassLookup.find(g => g.id === item.glass_id);
        const row = document.createElement('tr');
        row.className = 'border-b border-blackline-100';
        row.innerHTML = `
            <td class="py-3 px-2 font-mono text-xs text-blackline-500">${String(i+1).padStart(2,'0')}</td>
            <td class="py-3 px-2 text-blackline-700">${item.extracted_note}</td>
            <td class="py-3 px-2"><span class="bg-accent/10 text-accent-dark text-xs font-semibold px-2 py-1 rounded">${item.product_id.replace(/-/g, ' ')}</span></td>
            <td class="py-3 px-2 text-blackline-500 text-xs">${glass ? glass.name : item.glass_id}</td>
            <td class="py-3 px-2 text-right font-semibold">${item.quantity}</td>
        `;
        tbody.appendChild(row);
    });
}

function editExtraction() {
    // Store data for the quote builder
    sessionStorage.setItem('prefillItems', JSON.stringify(extractionData.extracted_items));
    window.location.href = '/quote';
}

async function generateFromExtraction() {
    const payload = {
        client_name: 'From AI Takeoff',
        project_address: 'Extracted from ' + (selectedFile ? selectedFile.name : 'uploaded document'),
        items: extractionData.extracted_items.map(item => ({
            product_id: item.product_id,
            size_index: item.size_index,
            quantity: item.quantity,
            glass_id: item.glass_id,
            finish_id: item.finish_id,
            addon_ids: item.addon_ids,
        })),
    };

    const resp = await fetch('/api/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
    });

    const data = await resp.json();
    sessionStorage.setItem('quoteResult', JSON.stringify(data));
    window.location.href = '/result';
}
</script>
{% endblock %}
